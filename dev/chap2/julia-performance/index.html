<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Performance and Profile · Scientific Computing For Physicists</title><meta name="title" content="Performance and Profile · Scientific Computing For Physicists"/><meta property="og:title" content="Performance and Profile · Scientific Computing For Physicists"/><meta property="twitter:title" content="Performance and Profile · Scientific Computing For Physicists"/><meta name="description" content="Documentation for Scientific Computing For Physicists."/><meta property="og:description" content="Documentation for Scientific Computing For Physicists."/><meta property="twitter:description" content="Documentation for Scientific Computing For Physicists."/><meta property="og:url" content="https://book.jinguo-group.science/chap2/julia-performance/"/><meta property="twitter:url" content="https://book.jinguo-group.science/chap2/julia-performance/"/><link rel="canonical" href="https://book.jinguo-group.science/chap2/julia-performance/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Scientific Computing For Physicists</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Become an Open-source Developer</span><ul><li><a class="tocitem" href="../../chap1/terminal/">Get a Terminal!</a></li><li><a class="tocitem" href="../../chap1/git/">Maintainability - Version Control</a></li><li><a class="tocitem" href="../../chap1/ci/">Correctness - Unit Tests</a></li></ul></li><li><span class="tocitem">Julia Programming Language</span><ul><li><a class="tocitem" href="../julia-setup/">Setup Julia</a></li><li><a class="tocitem" href="../julia-why/">Why Julia?</a></li><li><a class="tocitem" href="../julia-type/">Types and Multiple-dispatch</a></li><li><a class="tocitem" href="../julia-release/">My First Package</a></li><li class="is-active"><a class="tocitem" href>Performance and Profile</a><ul class="internal"><li><a class="tocitem" href="#Profiling"><span>Profiling</span></a></li></ul></li></ul></li><li><span class="tocitem">Tensors (×)</span><ul><li><a class="tocitem" href="../../chap3/array/">Array and Broadcasting</a></li><li><a class="tocitem" href="../../chap3/linalg/">Basic Linear Algebra</a></li><li><a class="tocitem" href="../../chap3/factorization/">Matrix factorization</a></li><li><a class="tocitem" href="../../chap3/fft/">Fast Fourier transform</a></li><li><a class="tocitem" href="../../chap3/tensors/">Tensor Operations</a></li><li><a class="tocitem" href="../../chap3/cuda/">Arrays on GPU</a></li></ul></li><li><span class="tocitem">Optimization (×)</span><ul><li><a class="tocitem" href="../../chap4/combinatorial/">Combinatorial Optimization</a></li><li><a class="tocitem" href="../../chap4/optimization/">Optimization</a></li><li><a class="tocitem" href="../../chap4/ad/">Automatic Differentiation</a></li></ul></li><li><span class="tocitem">Randomness (×)</span><ul><li><a class="tocitem" href="../../chap5/montecarlo/">Markov Chain Monte Carlo</a></li></ul></li><li><span class="tocitem">Sparsity (×)</span><ul><li><a class="tocitem" href="../../chap6/sparse/">Sparse Matrices</a></li><li><a class="tocitem" href="../../chap6/compressedsensing/">Compressed sensing</a></li></ul></li><li><span class="tocitem">High Performance Computing (×)</span><ul><li><a class="tocitem" href="../../chap7/hpc/">MPI and OpenMP</a></li><li><a class="tocitem" href="../../chap7/cuda/">CUDA programming</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Julia Programming Language</a></li><li class="is-active"><a href>Performance and Profile</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Performance and Profile</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/GiggleLiu/ScientificComputingForPhysicists" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/GiggleLiu/ScientificComputingForPhysicists/blob/main/docs/src/chap2/julia-performance.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Performance-and-Profile"><a class="docs-heading-anchor" href="#Performance-and-Profile">Performance and Profile</a><a id="Performance-and-Profile-1"></a><a class="docs-heading-anchor-permalink" href="#Performance-and-Profile" title="Permalink"></a></h1><h2 id="Profiling"><a class="docs-heading-anchor" href="#Profiling">Profiling</a><a id="Profiling-1"></a><a class="docs-heading-anchor-permalink" href="#Profiling" title="Permalink"></a></h2><p>Profiling is a way to measure the performance of your code. It can help you to identify the bottleneck of your code and optimize it. The <a href="https://docs.julialang.org/en/v1/manual/profile/">Profile</a> module in Julia provides a set of tools to profile your code.</p><p>Consider we have two random matrices <code>A</code> and <code>B</code>, and we want to measure the performance of the matrix multiplication <code>A * B</code>.</p><p>We can start the profiler by</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; using Profile</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; Profile.init(n = 10^7, delay = 0.001) # set the number of samples and the delay between samples</code><code class="nohighlight hljs ansi" style="display:block;"></code></pre><p>Then you can profile your code by running it.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; A, B = rand(1000, 1000), rand(1000, 1000);</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; A * B;  # the first run contains the compilation time</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; @profile A * B;</code><code class="nohighlight hljs ansi" style="display:block;"></code></pre><p>To view the profile result, you can use the <code>Profile.print()</code> function.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; Profile.print(; C=true, mincount=3)</code><code class="nohighlight hljs ansi" style="display:block;">Overhead ╎ [+additional indent] Count File:Line; Function
=========================================================
  ╎35 julia:?; 
  ╎ 35 …_64-linux-gnu/libc.so.6:?; __libc_start_main
  ╎  35 …_64-linux-gnu/libc.so.6:?; 
  ╎   35 julia:?; main
  ╎    35 …-1-dot-10/src/jlapi.c:731; jl_repl_entrypoint
  ╎     35 …-1-dot-10/src/jlapi.c:582; true_main
  ╎    ╎ 35 …1-dot-10/src/julia.h:1982; jl_apply
  ╎    ╎  35 …se-1-dot-10/src/gf.c:3076; ijl_apply_generic
  ╎    ╎   35 …e-1-dot-10/src/gf.c:2894; _jl_invoke
  ╎    ╎    35 …x64/lib/julia/sys.so:?; jfptr__start_82662.1
  ╎    ╎     35 @Base/client.jl:552; _start()
  ╎    ╎    ╎ 35 @Base/client.jl:291; exec_options(opts::Base.JLOptions)
  ╎    ╎    ╎  35 @Base/boot.jl:385; eval
  ╎    ╎    ╎   35 …-10/src/toplevel.c:985; ijl_toplevel_eval_in
  ╎    ╎    ╎    35 …10/src/toplevel.c:877; jl_toplevel_eval_flex
  ╎    ╎    ╎     35 …10/src/toplevel.c:934; jl_toplevel_eval_flex
  ╎    ╎    ╎    ╎ 35 …src/interpreter.c:775; jl_interpret_toplevel_thunk
  ╎    ╎    ╎    ╎  35 …rc/interpreter.c:617; eval_body
  ╎    ╎    ╎    ╎   35 …rc/interpreter.c:174; eval_stmt_value
  ╎    ╎    ╎    ╎    35 …c/interpreter.c:223; eval_value
  ╎    ╎    ╎    ╎     35 …c/interpreter.c:126; do_call
  ╎    ╎    ╎    ╎    ╎ 35 …10/src/julia.h:1982; jl_apply
  ╎    ╎    ╎    ╎    ╎  35 …ot-10/src/gf.c:3076; ijl_apply_generic
  ╎    ╎    ╎    ╎    ╎   35 …t-10/src/gf.c:2894; _jl_invoke
  ╎    ╎    ╎    ╎    ╎    35 [unknown stackframe]
  ╎    ╎    ╎    ╎    ╎     35 …ase/client.jl:489; include(fname::String)
  ╎    ╎    ╎    ╎    ╎    ╎ 35 …e/loading.jl:2136; _include(mapexpr::Function,…
  ╎    ╎    ╎    ╎    ╎    ╎  35 …-10/src/gf.c:3076; ijl_apply_generic
  ╎    ╎    ╎    ╎    ╎    ╎   35 …10/src/gf.c:2894; _jl_invoke
  ╎    ╎    ╎    ╎    ╎    ╎    35 …/loading.jl:2076; include_string(mapexpr::t…
  ╎    ╎    ╎    ╎    ╎    ╎     35 …ase/boot.jl:385; eval
  ╎    ╎    ╎    ╎    ╎    ╎    ╎ 35 …/toplevel.c:985; ijl_toplevel_eval_in
  ╎    ╎    ╎    ╎    ╎    ╎    ╎  35 …/toplevel.c:877; jl_toplevel_eval_flex
  ╎    ╎    ╎    ╎    ╎    ╎    ╎   35 …/toplevel.c:934; jl_toplevel_eval_flex
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    35 …terpreter.c:775; jl_interpret_toplevel…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎     35 …terpreter.c:617; eval_body
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ 35 …terpreter.c:174; eval_stmt_value
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎  35 …terpreter.c:223; eval_value
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎   35 …terpreter.c:126; do_call
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎    35 …src/julia.h:1982; jl_apply
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎     35 …10/src/gf.c:3076; ijl_apply_gene…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎  +1 35 …10/src/gf.c:2894; _jl_invoke
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎  +2 35 [unknown stackframe]
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎  +3 35 …makedocs.jl:241; kwcall(::@Named…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎  +4 35 …makedocs.jl:247; #makedocs#81
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎  +5 35 …ase/file.jl:112; cd(f::Documente…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎  +6 35 …makedocs.jl:247; #82
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎  +7 35 …/builtins.c:768; do_apply
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎  +8 35 …src/julia.h:1982; jl_apply
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎  +9 35 …10/src/gf.c:3076; ijl_apply_gene…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +10 35 …10/src/gf.c:2894; _jl_invoke
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +11 35 @Base/env.jl:257; withenv(::Docum…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +12 35 …makedocs.jl:248; #83
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +13 35 …electors.jl:170; dispatch(::Type…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +14 35 …10/src/gf.c:3076; ijl_apply_gene…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +15 35 …10/src/gf.c:2894; _jl_invoke
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +16 35 …jf_7mwBE.so:?; jfptr_runner_12495
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +17 35 …pipeline.jl:222; runner(::Type{D…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +18 35 …pipeline.jl:22; expand(doc::Docu…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +19 35 …electors.jl:170; dispatch(::Type…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +20 35 …/builtins.c:768; do_apply
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +21 35 …src/julia.h:1982; jl_apply
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +22 35 …10/src/gf.c:3076; ijl_apply_gene…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +23 35 …10/src/gf.c:2894; _jl_invoke
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +24 35 [unknown stackframe]
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +25 35 …pipeline.jl:846; runner(::Type{D…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +26 35 …10/src/gf.c:3076; ijl_apply_gene…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +27 35 …10/src/gf.c:2894; _jl_invoke
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +28 35 [unknown stackframe]
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +29 35 …OCapture.jl:96; kwcall(::@NamedT…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +30 35 …10/src/gf.c:3076; ijl_apply_gene…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +31 35 …10/src/gf.c:2894; _jl_invoke
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +32 35 [unknown stackframe]
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +33 35 …OCapture.jl:158; capture(f::Docu…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +34 35 …/logging.jl:627; with_logger
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +35 35 …/logging.jl:515; with_logstate(f…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +36 35 …10/src/gf.c:3076; ijl_apply_gene…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +37 35 …10/src/gf.c:2894; _jl_invoke
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +38 35 [unknown stackframe]
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +39 35 …OCapture.jl:161; (::IOCapture.va…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +40 35 …pipeline.jl:847; (::Documenter.v…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +41 35 …ase/file.jl:112; cd(f::Documente…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +42 35 …pipeline.jl:848; #62
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +43 35 …ase/boot.jl:385; eval
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +44 35 …/toplevel.c:985; ijl_toplevel_ev…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +45 35 …/toplevel.c:877; jl_toplevel_eva…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +46 35 …/toplevel.c:877; jl_toplevel_eva…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +47 35 …/toplevel.c:934; jl_toplevel_eva…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +48 35 …terpreter.c:775; jl_interpret_to…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +49 32 …terpreter.c:544; eval_body
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +50 32 …terpreter.c:489; eval_body
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +51 32 …terpreter.c:223; eval_value
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +52 32 …terpreter.c:126; do_call
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +53 32 …src/julia.h:1982; jl_apply
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +54 32 …10/src/gf.c:3076; ijl_apply_gene…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +55 32 …10/src/gf.c:2894; _jl_invoke
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +56 32 [unknown stackframe]
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +57 32 …c/matmul.jl:113; *(A::Matrix{Flo…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +58 32 …c/matmul.jl:237; mul!
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +59 32 …c/matmul.jl:263; mul!
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +60 32 …c/matmul.jl:352; generic_matmatm…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +61 32 …c/matmul.jl:605; gemm_wrapper!(C…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +62 32 …src/blas.jl:1524; gemm!(transA::…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +63 32 …nblas64_.so:?; dgemm_64_
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +64 32 …nblas64_.so:?; dgemm_nn
27╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +65 27 …nblas64_.so:?; dgemm_kernel_SKYL…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +49 3  …terpreter.c:617; eval_body
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +50 3  …terpreter.c:174; eval_stmt_value
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +51 3  …terpreter.c:223; eval_value
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +52 3  …terpreter.c:126; do_call
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +53 3  …src/julia.h:1982; jl_apply
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +54 3  …10/src/gf.c:3076; ijl_apply_gene…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +55 3  …10/src/gf.c:2886; _jl_invoke
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +56 3  …10/src/gf.c:2368; jl_compile_met…
  ╎    ╎    ╎    ╎    ╎    ╎    ╎    ╎ +57 3  …10/src/gf.c:2480; jl_compile_met…
Total snapshots: 37. Utilization: 100% across all threads and tasks. Use the `groupby` kwarg to break down by thread and/or task.</code></pre><p>The majority of the time is spent in the GEMM function of the BLAS library, which is a highly optimized library for matrix multiplication. The performance of the matrix multiplication is close to the theoretical peak performance of the CPU.</p><h3 id="Example:-Optimizing-the-performance-of-Lorenz-attractor"><a class="docs-heading-anchor" href="#Example:-Optimizing-the-performance-of-Lorenz-attractor">Example: Optimizing the performance of Lorenz attractor</a><a id="Example:-Optimizing-the-performance-of-Lorenz-attractor-1"></a><a class="docs-heading-anchor-permalink" href="#Example:-Optimizing-the-performance-of-Lorenz-attractor" title="Permalink"></a></h3><p>Consider we have a simple implementation of the <a href="https://en.wikipedia.org/wiki/Lorenz_system">Lorenz attractor</a> using the <a href="https://en.wikipedia.org/wiki/Runge%E2%80%93Kutta_methods">Runge-Kutta method</a>. The code is as follows:</p><pre><code class="language-julia hljs"># Point in 3D space
struct P3{T}
    x::T
    y::T
    z::T
end

# Overload the zero function
Base.zero(::Type{P3{T}}) where T = P3(zero(T), zero(T), zero(T))
Base.zero(::P3{T}) where T = P3(zero(T), zero(T), zero(T))


# Overload the addition, subtraction, division and multiplication
@inline function Base.:(+)(a::P3, b::P3)
    P3(a.x + b.x, a.y + b.y, a.z + b.z)
end

@inline function Base.:(/)(a::P3, b::Real)
    P3(a.x/b, a.y/b, a.z/b)
end

@inline function Base.:(*)(a::Real, b::P3)
    P3(a*b.x, a*b.y, a*b.z)
end


# define the Lorenz attractor
function lorenz(t, y)
    P3(10*(y.y-y.x), y.x*(27-y.z)-y.y, y.x*y.y-8/3*y.z)
end

# define the single step update for the Runge-Kutta method of order 4
# f: the function to be integrated
# t: the current time
# y: the current value
# Δt: the current time step
function rk4_step(f, t, y, Δt)
    k1 = Δt * f(t, y)
    k2 = Δt * f(t+Δt/2, y + k1 / 2)
    k3 = Δt * f(t+Δt/2, y + k2 / 2)
    k4 = Δt * f(t+Δt, y + k3)
    return y + k1/6 + k2/3 + k3/3 + k4/6
end

# define the Runge-Kutta method of order 4
# f: the function to be integrated
# y0: the initial value
# t0: the initial time
# Δt: the time step
# Nt: the number of steps
function rk4(f, y0; t0, Δt, Nt, history=nothing)
    y = y0
    for i=1:Nt
        y = rk4_step(f, t0+(i-1)*Δt, y, Δt)
        # record the history
        record!(history, y)
    end
    return y
end

# record the history: if history is a vector, push the value to the vector
record!(v::AbstractVector, y) = push!(v, y)
record!(::Nothing, y) = nothing</code></pre><p>If we run the code, we can see the Lorenz attractor.</p><pre><code class="language-julia hljs">y = P3(1.0, 0.0, 0.0)
history = [y]
rk4(lorenz, y; t0=0.0, Δt=0.001, Nt=100000, history)

using Plots; gr(dpi=100)
plot([h.x for h in history], [h.y for h in history], [h.z for h in history], legend=false)</code></pre><img src="9267264e.svg" alt="Example block output"/><p>The performance of the code </p><pre><code class="language-julia-repl hljs">julia&gt; @benchmark rk4(lorenz, P3(1.0, 0.0, 0.0); t0=0.0, Δt=0.001, Nt=100000, history=[])
BenchmarkTools.Trial: 1479 samples with 1 evaluation.
 Range (min … max):  3.167 ms …   7.822 ms  ┊ GC (min … max): 0.00% … 56.98%
 Time  (median):     3.263 ms               ┊ GC (median):    0.00%
 Time  (mean ± σ):   3.381 ms ± 321.910 μs  ┊ GC (mean ± σ):  3.06% ±  6.93%

  ▂▃▅█▇▅▄▃▃▁▁▂▂▁                              ▁▂▂▁             
  ██████████████▇▅▄▄▅▁▄▄▁▁▄▁▁▄▁▁▁▁▁▁▁▁▁▁▁▁▅▇▆▆████▇▇▆▅▆▅▄▅▅▅▄ █
  3.17 ms      Histogram: log(frequency) by time      4.43 ms &lt;

 Memory estimate: 4.88 MiB, allocs estimate: 100011.</code></pre><p>It is reasonable to suspect that the performance bottleneck is the <code>record!</code> function, because the <code>history</code> is a vector of element type <code>Any</code>. In order to verify our intuition, we can profile the code to see the performance bottleneck.</p><pre><code class="language-julia hljs">Profile.clear()   # clear the previous profile result
@profile rk4(lorenz, P3(1.0, 0.0, 0.0); t0=0.0, Δt=0.001, Nt=5000000, history=[]) # record the profile
Profile.print(format=:flat, mincount=5)  # show the profile result, only show the functions that are called more than 5 times</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"> Count  Overhead File                    Line Function
 =====  ======== ====                    ==== ========
     6         6 @Base/array.jl          1026 __inbounds_setindex!
    62        62 @Base/array.jl          1072 _growend!
    62         0 @Base/array.jl          1126 push!
     6         0 @Base/array.jl          1127 push!
   940        19 @Base/boot.jl            385 eval
   940         0 @Base/client.jl          552 _start()
   940         0 @Base/client.jl          291 exec_options(opts::Base.JLOptions)
   940         0 @Base/client.jl          489 include(fname::String)
   940         0 @Base/env.jl             257 withenv(::Documenter.var&quot;#83#85&quot;{…
   940         0 @Base/file.jl            112 cd(f::Documenter.var&quot;#82#84&quot;{Docu…
    60        60 @Base/float.jl           411 *
    15        15 @Base/float.jl           409 +
    34        34 @Base/float.jl           410 -
    29        29 @Base/float.jl           412 /
   845       695 julia-performance.md      84 rk4(f::Function, y0::Main.__atexa…
    68         0 julia-performance.md      86 rk4(f::Function, y0::Main.__atexa…
    26         0 julia-performance.md      53 *
    11         0 julia-performance.md      45 +
    29         0 julia-performance.md      49 /
    68         0 julia-performance.md      59 lorenz
    68         0 julia-performance.md      92 record!
   918         5 julia-performance.md      81 kwcall(::@NamedTuple{t0::Float64,…
     6         6 julia-performance.md      67 rk4_step(f::typeof(Main.__atexamp…
     6         0 julia-performance.md      68 rk4_step(f::typeof(Main.__atexamp…
    29         0 julia-performance.md      69 rk4_step(f::typeof(Main.__atexamp…
    40         0 julia-performance.md      70 rk4_step(f::typeof(Main.__atexamp…
    32         0 julia-performance.md      71 rk4_step(f::typeof(Main.__atexamp…
    29         2 julia-performance.md      72 rk4_step(f::typeof(Main.__atexamp…
   940         0 @Base/loading.jl        2136 _include(mapexpr::Function, mod::…
   940         0 @Base/loading.jl        2076 include_string(mapexpr::typeof(id…
   940         0 @Base/logging.jl         627 with_logger
   940         0 @Base/logging.jl         515 with_logstate(f::Function, logsta…
    34         0 @Base/promotion.jl       423 *
    29         0 @Base/promotion.jl       425 /
   940         0 …c/builder_pipeline.jl   222 runner(::Type{Documenter.Builder.…
   940         0 …/expander_pipeline.jl   753 (::Documenter.var&quot;#57#59&quot;{Documen…
   940         0 …/expander_pipeline.jl   754 #58
   940         0 …/expander_pipeline.jl    22 expand(doc::Documenter.Document)
   940         0 …/expander_pipeline.jl   752 runner(::Type{Documenter.Expander…
   940         0 …enter/src/makedocs.jl   247 #82
   940         0 …enter/src/makedocs.jl   248 #83
   940         0 …enter/src/makedocs.jl   247 #makedocs#81
   940         0 …enter/src/makedocs.jl   241 kwcall(::@NamedTuple{modules::Vec…
   940         0 …tilities/Selectors.jl   170 dispatch(::Type{Documenter.Builde…
   940         0 …ture/src/IOCapture.jl   161 (::IOCapture.var&quot;#4#7&quot;{DataType, …
   940         0 …ture/src/IOCapture.jl   158 capture(f::Documenter.var&quot;#57#59&quot;…
   940         0 …ture/src/IOCapture.jl    96 kwcall(::@NamedTuple{rethrow::Dat…
Total snapshots: 942. Utilization: 100% across all threads and tasks. Use the `groupby` kwarg to break down by thread and/or task.</code></pre><p>The <code>print</code> also supports other formats, such as <code>:tree</code>.</p><p>In this example, we can see that the <code>record!</code> function has only a few counts, each count stands for <span>$10^{-3}s$</span>. So the <code>record!</code> function is not the performance bottleneck. The performance bottleneck is the <code>rk4</code> function.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../julia-release/">« My First Package</a><a class="docs-footer-nextpage" href="../../chap3/array/">Array and Broadcasting »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Thursday 22 February 2024 04:11">Thursday 22 February 2024</span>. Using Julia version 1.10.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
